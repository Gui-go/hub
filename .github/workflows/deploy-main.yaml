name: Hub CI/CD

on:
  push:
    branches:
      - main
      - dev

env:
  TF_VERSION: 1.1.5
  TG_VERSION: 0.38.7
  TG_DIR: ./terragrunt/environments/dev
  TF_IN_AUTOMATION: "true"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup Terragrunt
        uses: autero1/action-terragrunt@v1.1.0
        with:
          terragrunt_version: ${{ env.TG_VERSION }}

      - name: Terragrunt Format
        id: fmt
        run: terragrunt hclfmt --terragrunt-check --terragrunt-non-interactive
        working-directory: ${{ env.TG_DIR }}

      - name: Terragrunt Init
        id: init
        run: terragrunt run-all init --terragrunt-non-interactive
        working-directory: ${{ env.TG_DIR }}

      - name: Terragrunt Plan
        id: plan
        run: terragrunt run-all plan --terragrunt-non-interactive -out=plan.out
        working-directory: ${{ env.TG_DIR }}
        continue-on-error: true

      - name: Terragrunt Show
        id: show
        run: terragrunt run-all show plan.out
        working-directory: ${{ env.TG_DIR }}

      - name: Terragrunt Apply
        run: terragrunt run-all apply --terragrunt-non-interactive -auto-approve
        working-directory: ${{ env.TG_DIR }}
